<form class="form-container">
    <div class="flex">
        <div>
            <label><span>¿Cuántas horas necesitas dormir cada día?</span><sup>hh:mm</sup></label>
            <input id="neededSleepHours" type="time" name="neededSleepHours_input" min="00:00" max="23:59" required>
            <span id="invalid_neededSleepHours" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>Horas dormidas el lunes</span><sup>hh:mm</sup></label>
            <input id="monday" type="time" name="monday_input" min="00:00" max="23:59" required>
            <span id="invalid_monday" style="display: none;"></span>
        </div>
        <div>
            <label><span>Horas dormidas el martes</span><sup>hh:mm</sup></label>
            <input id="tuesday" type="time" name="tuesday_input" min="00:00" max="23:59" required>
            <span id="invalid_tuesday" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>Horas dormidas el miércoles</span><sup>hh:mm</sup></label>
            <input id="wednesday" type="time" name="wednesday_input" min="00:00" max="23:59" required>
            <span id="invalid_wednesday" style="display: none;"></span>
        </div>
        <div>
            <label><span>Horas dormidas el jueves</span><sup>hh:mm</sup></label>
            <input id="thursday" type="time" name="thursday_input" min="00:00" max="23:59" required>
            <span id="invalid_thursday" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>Horas dormidas el viernes</span><sup>hh:mm</sup></label>
            <input id="friday" type="time" name="friday_input" min="00:00" max="23:59" required>
            <span id="invalid_friday" style="display: none;"></span>
        </div>
        <div>
            <label><span>Horas dormidas el sábado</span><sup>hh:mm</sup></label>
            <input id="saturday" type="time" name="saturday_input" min="00:00" max="23:59" required>
            <span id="invalid_saturday" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>Horas dormidas el domingo</span><sup>hh:mm</sup></label>
            <input id="sunday" type="time" name="sunday_input" min="00:00" max="23:59" required>
            <span id="invalid_sunday" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>¿En cuántos días quieres recuperar tu deuda de sueño?</span></label>
            <input id="daysToRecover" type="text" min="1" max="365" maxlength="3" name="daysToRecover_input" placeholder="Introduce el número de días" required>
            <span id="invalid_daysToRecover" style="display: none;"></span>
        </div>
    </div>
    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<script type="text/javascript">
    (function() {

        //Inputs de horas
        const NEEDED_SLEEP_HOURS = document.querySelector('#neededSleepHours');
        const MONDAY = document.querySelector('#monday');
        const TUESDAY = document.querySelector('#tuesday');
        const WEDNESDAY = document.querySelector('#wednesday');
        const THURSDAY = document.querySelector('#thursday');
        const FRIDAY = document.querySelector('#friday');
        const SATURDAY = document.querySelector('#saturday');
        const SUNDAY = document.querySelector('#sunday');

        //Input días para recuperar
        const DAYS_TO_RECOVER = document.querySelector('#daysToRecover');
        const INVALID_DAYS_TO_RECOVER = document.querySelector('#invalid_daysToRecover');

        //Caja con el resultado
        const RESULT_BOX = document.querySelector('.result');

        //Botón de calcular
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Formulario
        const FORM = document.querySelector('.form-container');

        //Regex para comprobar si los números cumplen con la condición de ser enteros
        const INTEGERS_REGEX = new RegExp(/^\d+$/);

        //Comprobar si ha introducido correctamente el número de días
        DAYS_TO_RECOVER.addEventListener('input', ()=>{

            //Comprobar si el numero es un entero
            if(!INTEGERS_REGEX.test(DAYS_TO_RECOVER.value)){
                DAYS_TO_RECOVER.setCustomValidity('Introduce un número de días válido');
                DAYS_TO_RECOVER.reportValidity();
                return
            }

            const VALUE = parseInt(DAYS_TO_RECOVER.value);
            const MIN = parseInt(DAYS_TO_RECOVER.getAttribute('min'));
            const MAX = parseInt(DAYS_TO_RECOVER.getAttribute('max'));

            //Comprobar si el numero es entre los min y max
            if(VALUE < MIN || VALUE > MAX || isNaN(VALUE)){
                DAYS_TO_RECOVER.setCustomValidity(`Los días mínimos son ${MIN} y los máximos son ${MAX}`);
                DAYS_TO_RECOVER.reportValidity();
            }else{
                DAYS_TO_RECOVER.setCustomValidity('');
            }
        })

        FORM.addEventListener('submit', (e)=>{
            e.preventDefault();

            //Cambiar texto botón
            CALCULATE_BTN.innerHTML = 'Calculando...';

            //Ocultar resultado anterior
            RESULT_BOX.style.visibility = 'hidden';

            const neededSleepHours = NEEDED_SLEEP_HOURS.value;
            const monday = MONDAY.value;
            const tuesday = TUESDAY.value;
            const wednesday = WEDNESDAY.value;
            const thursday = THURSDAY.value;
            const friday = FRIDAY.value;
            const saturday = SATURDAY.value;
            const sunday = SUNDAY.value;
            const daysToRecover = parseInt(DAYS_TO_RECOVER.value);

            const CALCULATOR = new SleepDebtCalculator(
                neededSleepHours,
                monday,
                tuesday,
                wednesday,
                thursday,
                friday,
                saturday,
                sunday,
                daysToRecover
            );

            const result = CALCULATOR.sleepDebt;

            setTimeout(()=>{

                //Scroll smooth hasta el resultado
                RESULT_BOX.scrollIntoView({behavior: 'smooth', block: 'center'});

                //Volver a poner el texto en el boton
                CALCULATE_BTN.innerHTML = 'Calcular';

                //Mostrar el resultado
                RESULT_BOX.style.visibility = 'visible';

                RESULT_BOX.innerHTML = `<span>Tienes <strong>${result.debtFormatted} hora(s)</strong> de deuda de sueño.</span><br><span>Lo podrás recuperar durmiendo <strong>${result.debtPerDayFormatted} hora(s)</strong> más en los próximos <strong>${daysToRecover} días</strong></span>`

            }, 500)

        })

    })();

    class SleepDebtCalculator {
        _neededSleepHours;
        _monday;
        _tuesday;
        _wednesday;
        _thursday;
        _friday;
        _saturday;
        _sunday;
        _daysToRecover;

        constructor(neededSleepHours, monday, tuesday, wednesday, thursday, friday, saturday, sunday, daysToRecover) {
            this._neededSleepHours = neededSleepHours;
            this._monday = monday;
            this._tuesday = tuesday;
            this._wednesday = wednesday;
            this._thursday = thursday;
            this._friday = friday;
            this._saturday = saturday;
            this._sunday = sunday;
            this._daysToRecover = daysToRecover;
        }

        get sleepDebt(){
            const totalSleepNeeded = (this.minutesFromHours(this._neededSleepHours)) * 7;

            const days = [this._monday, this._tuesday, this._wednesday, this._thursday, this._friday, this._saturday, this._sunday];
            let totalSleept = 0;
            for (const day of days) {
                totalSleept += this.minutesFromHours(day);
            }

            const debt = totalSleepNeeded - totalSleept;
            const debtFormatted = `${String(Math.floor(debt / 60)).padStart(2, '0')}:${String(debt % 60).padStart(2, '0')}`;
            const debtPerDay = debt / this._daysToRecover;
            const debtPerDayFormatted = `${String(Math.floor(debtPerDay / 60)).padStart(2, '0')}:${String(Math.floor(debtPerDay % 60)).padStart(2, '0')}`;

            return {
                debtFormatted,
                debtPerDayFormatted,
            }
        }

        minutesFromHours(time){
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }
    }
</script>
