<form class="form-container">
    <div class="flex">
        <div>
            <label><span>Elige qué quieres calcular:</span></label>
            <select id="calculatorType" type="select" name="calculatorType_input">
                <option disabled selected>Selecciona una opción</option>
                <option value="a">Fijar la hora de irte a dormir y calcular nº ciclos de sueño</option>
                <option value="b">Fijar nº ciclos de sueño y calcular la hora de irte a dormir</option>
            </select>
        </div>
    </div>
    <div class="flex" id="option_a" style="display: none;">
        <div>
            <label><span>Hora a la que te vas a dormir</span><sup>hh:mm</sup></label>
            <input id="sleepHour" type="time" name="sleepHour_input" min="00:00" max="23:59">
            <span id="invalid_sleepHour" style="display: none;"></span>
        </div>
        <div>
            <label><span>Hora a la que te quieres despertar</span><sup>hh:mm</sup></label>
            <input id="wakeHour" type="time" name="wakeHour_input" min="00:00" max="23:59">
            <span id="invalid_wakeHour" style="display: none;"></span>
        </div>
    </div>
    <div class="flex" id="option_b" style="display: none;">
        <div>
            <label><span>Hora a la que te quieres despertar</span><sup>hh:mm</sup></label>
            <input id="desireAwakeHour" type="time" name="desireAwakeHour_input" min="00:00" max="23:59">
            <span id="invalid_desireAwakeHour" style="display: none;"></span>
        </div>
        <div>
            <label><span>¿Cuántos ciclos de sueño quieres completar (90 min/ciclo)?</span></label>
            <input id="sleepCicles" type="text" min="1" max="10" maxlength="2" name="sleepCicles_input" placeholder="Introduce el número de ciclos">
            <span id="invalid_sleepCicles" style="display: none;"></span>
        </div>
    </div>
    <div class="flex">
        <div>
            <label><span>¿Te despiertas alguna vez durante la noche?</span></label>
            <select id="interruptedSleep" type="select" name="interruptedSleep_input">
                <option disabled selected>Selecciona una opción</option>
                <option value="y">Si</option>
                <option value="n">No</option>
            </select>
        </div>
    </div>
    <div class="flex" id="isInterruptedSleep" style="display: none;">
        <div>
            <label><span>¿Cuántas veces te despiertas durante la noche?</span></label>
            <input id="interruptedTimes" type="text" min="1" max="10" maxlength="2" name="interruptedTimes_input" placeholder="Introduce el número de veces que te despiertas">
            <span id="invalid_interruptedTimes" style="display: none;"></span>
        </div>
        <div>
            <label><span>¿Cuánto tiempo estás despierto durante la noche, contando todos los despertares?</span><sup>hh:mm</sup></label>
            <input id="interruptedTime" type="time" name="interruptedTime_input" min="00:00" max="23:59">
            <span id="invalid_interruptedTime" style="display: none;"></span>
        </div>
    </div>
    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<script type="text/javascript">
    (function() {

        //Select tipo calculadora
        const CALCULATOR_TYPE = document.querySelector('#calculatorType');

        //Contenedor de opciones
        const OPTION_A = document.querySelector('#option_a');
        const OPTION_B = document.querySelector('#option_b');

        //Input hora a la que te vas a dormir
        const SLEEP_HOUR = document.querySelector('#sleepHour');
        const INVALID_SLEEP_HOUR = document.querySelector('#invalid_sleepHour');

        //Input hora a la que te quieres despertar
        const WAKE_HOUR = document.querySelector('#wakeHour');
        const INVALID_WAKE_HOUR = document.querySelector('#invalid_wakeHour');

        //Input hora a la que te quieres despertar
        const DESIRE_AWAKE_HOUR = document.querySelector('#desireAwakeHour');
        const INVALID_DESIRE_AWAKE_HOUR = document.querySelector('#invalid_desireAwakeHour');

        //Input ciclos de sueño que quieres completar
        const SLEEP_CICLES = document.querySelector('#sleepCicles');
        const INVALID_SLEEP_CICLES = document.querySelector('#invalid_sleepCicles');

        //Select si te despiertas alguna vez durante la noche
        const INTERRUPTED_SLEEP = document.querySelector('#interruptedSleep');

        //Contenedor si te despiertas alguna vez durante la noche
        const IS_INTERRUPTED_SLEEP = document.querySelector('#isInterruptedSleep');

        //Input veces que te despiertas durante la noche
        const INTERRUPTED_TIMES = document.querySelector('#interruptedTimes');
        const INVALID_INTERRUPTED_TIMES = document.querySelector('#invalid_interruptedTimes');

        //Input duración de las interrupciones
        const INTERRUPTED_TIME = document.querySelector('#interruptedTime');
        const INVALID_INTERRUPTED_TIME = document.querySelector('#invalid_interruptedTime');

        //Cajas con el resultado
        const RESULT_BOX = document.querySelector('.result');

        //Botón de calcular
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Formulario
        const FORM = document.querySelector('.form-container');

        //Regex para comprobar si los números cumplen con la condición de 2 decimales
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+.\d{1,2})$/);

        //Regex para comprobar si los números cumplen con la condición de 1 decimal
        const DECIMAL_REGEX = new RegExp(/^(\d+|\d+,\d{1}|\d+.\d{1})$/);

        //Regex para comprobar si los números cumplen con la condición de ser enteros
        const INTEGERS_REGEX = new RegExp(/^\d+$/);
        const NEGATIVE_INTEGERS_REGEX = new RegExp(/^-?\d+$/);

        //Comprobar que ha introducido valor en los select
        const SELECTS = document.querySelectorAll('select');
        SELECTS.forEach(select => {
            select.addEventListener('change', () => {
                if (select.value !== "" && select.selectedIndex !== 0) select.setCustomValidity('');

                if (select.id === "calculatorType") {
                    if (select.value === "a") {
                        OPTION_A.style.display = 'block';
                        OPTION_B.style.display = 'none';

                        SLEEP_HOUR.required = true;
                        WAKE_HOUR.required = true;
                        DESIRE_AWAKE_HOUR.required = false;
                        SLEEP_CICLES.required = false;
                    }

                    if (select.value === "b") {
                        OPTION_A.style.display = 'none';
                        OPTION_B.style.display = 'block';

                        SLEEP_HOUR.required = false;
                        WAKE_HOUR.required = false;
                        DESIRE_AWAKE_HOUR.required = true;
                        SLEEP_CICLES.required = true;
                    }
                } else if (select.id === "interruptedSleep") {
                    if (select.value === "y") {
                        IS_INTERRUPTED_SLEEP.style.display = 'block';
                        INTERRUPTED_TIMES.required = true;
                        INTERRUPTED_TIME.required = true;
                    } else {
                        IS_INTERRUPTED_SLEEP.style.display = 'none';
                        INTERRUPTED_TIMES.required = false;
                        INTERRUPTED_TIME.required = false;
                    }
                }
            });
        });

        //Comprobar si ha introducido correctamente el numero de ciclos
        SLEEP_CICLES.addEventListener('input', ()=>{

            //Comprobar si el numero es un entero
            if(!INTEGERS_REGEX.test(SLEEP_CICLES.value)){
                SLEEP_CICLES.setCustomValidity('Introduce un número de ciclos válido');
                SLEEP_CICLES.reportValidity();
                return
            }

            const VALUE = parseInt(SLEEP_CICLES.value);
            const MIN = parseInt(SLEEP_CICLES.getAttribute('min'));
            const MAX = parseInt(SLEEP_CICLES.getAttribute('max'));

            //Comprobar si el numero es entre los min y max
            if(VALUE < MIN || VALUE > MAX || isNaN(VALUE)){
                SLEEP_CICLES.setCustomValidity(`Los ciclos mínimos son ${MIN} y los máximos son ${MAX}`);
                SLEEP_CICLES.reportValidity();
            }else{
                SLEEP_CICLES.setCustomValidity('');
            }
        })

        //Comprobar si ha introducido correctamente el numero de veces que te despiertas
        INTERRUPTED_TIMES.addEventListener('input', ()=>{

            //Comprobar si el numero es un entero
            if(!INTEGERS_REGEX.test(INTERRUPTED_TIMES.value)){
                INTERRUPTED_TIMES.setCustomValidity('Introduce un número válido');
                INTERRUPTED_TIMES.reportValidity();
                return
            }

            const VALUE = parseInt(INTERRUPTED_TIMES.value);
            const MIN = parseInt(INTERRUPTED_TIMES.getAttribute('min'));
            const MAX = parseInt(INTERRUPTED_TIMES.getAttribute('max'));

            //Comprobar si el numero es entre los min y max
            if(VALUE < MIN || VALUE > MAX || isNaN(VALUE)){
                INTERRUPTED_TIMES.setCustomValidity(`El mínimo son ${MIN} y el máximo son ${MAX}`);
                INTERRUPTED_TIMES.reportValidity();
            }else{
                INTERRUPTED_TIMES.setCustomValidity('');
            }
        })

        FORM.addEventListener('submit', (e)=>{
            e.preventDefault();

            const selects = document.querySelectorAll('select');
            let isValid = true;

            selects.forEach(select => {
                if (select.value === "" || select.selectedIndex === 0) {
                    select.setCustomValidity('Por favor, selecciona una opción');
                    select.reportValidity();
                    isValid = false;
                } else {
                    select.setCustomValidity('');
                }
            });

            if (!isValid) {
                return;
            }

            //Cambiar texto botón
            CALCULATE_BTN.innerHTML = 'Calculando...';

            //Ocultar resultado anterior
            RESULT_BOX.style.visibility = 'hidden';

            const type = CALCULATOR_TYPE.value;
            const sleepHour = SLEEP_HOUR.value ?? null;
            const wakeHour = WAKE_HOUR.value ?? null;
            const desireAwakeHour = DESIRE_AWAKE_HOUR.value ?? null;
            const sleepCicles = parseInt(SLEEP_CICLES.value) ?? null;
            const interruptedTimes = parseInt(INTERRUPTED_TIMES.value) ?? null;
            const interruptedTime = INTERRUPTED_TIME.value ?? null;

            const CALCULATOR = new SleepCycleCalculator(type, sleepHour, wakeHour, desireAwakeHour, sleepCicles, interruptedTimes, interruptedTime);
            let result = null;
            if (type === 'a') result = CALCULATOR.calculateSleepCycle();
            if (type === 'b') result = CALCULATOR.calculateTimeToSleep();

            setTimeout(()=>{

                //Scroll smooth hasta el resultado
                RESULT_BOX.scrollIntoView({behavior: 'smooth', block: 'center'});

                //Volver a poner el texto en el boton
                CALCULATE_BTN.innerHTML = 'Calcular';

                //Mostrar el resultado
                RESULT_BOX.style.visibility = 'visible';

                if (type === 'a'){
                    RESULT_BOX.innerHTML = `<span>Cumplirías con <strong>${result.totalCicles}</strong> ciclos de sueño.</span><br><span><strong>${result.isRecommended ? 'Sí' : 'No'}</strong> cumples con el mínimo recomendado (4 ciclos)</span>`
                } else {
                    RESULT_BOX.innerHTML = `<span>Deberías irte a dormir a las  <strong>${result.bedTime}</strong> h.</span><br><span><strong>${result.isRecommended ? 'Sí' : 'No'}</strong> cumples con el mínimo recomendado (7 horas)</span>`
                }

            }, 500)

        })

    })();
    class SleepCycleCalculator {

        _type;
        _sleepHour;
        _wakeHour;
        _desireAwakeHour;
        _sleepCicles;
        _interruptedTimes;
        _interruptedTime;

        constructor(type, sleepHour = null, wakeHour = null, desireAwakeHour = null, sleepCicles = null, interruptedTimes = null, interruptedTime = null) {
            this._type = type;
            this._sleepHour = sleepHour;
            this._wakeHour = wakeHour;
            this._desireAwakeHour = desireAwakeHour;
            this._sleepCicles = sleepCicles;
            this._interruptedTimes = interruptedTimes;
            this._interruptedTime = interruptedTime;
        }

        calculateSleepCycle() {
            const [h,m] = this._sleepHour.split(':').map(Number);
            const [h2,m2] = this._wakeHour.split(':').map(Number);
            let minutesSleeped = ((h2 * 60 + m2) - (h * 60 + m));

            if (minutesSleeped < 0) {
                minutesSleeped += 24 * 60;
            }

            if (this._interruptedTimes) {
                const [hAwake, mAwake] = this._interruptedTime.split(':').map(Number);
                const totalInterruptedTime = (15 * (1 + this._interruptedTimes)) + ((hAwake * 60 + mAwake));
                minutesSleeped -= totalInterruptedTime;
            } else {
                minutesSleeped -= 15;
            }

            const totalCicles = (minutesSleeped / 90).toFixed(1);
            const isRecommended = parseFloat(totalCicles) >= 4 ? true : false;

            return {
                totalCicles,
                isRecommended,
                hoursSleeped: `${String(Math.floor(minutesSleeped / 60)).padStart(2, '0')}:${String(minutesSleeped % 60).padStart(2, '0')}`,
            }
        }

        calculateTimeToSleep() {
            let totalSleepTimeNeeded = 90 * this._sleepCicles;
            const totalCicleHours = totalSleepTimeNeeded / 60;

            if (this._interruptedTimes) {
                const [hAwake, mAwake] = this._interruptedTime.split(':').map(Number);
                const totalInterruptedTime = (15 * (1 + this._interruptedTimes)) + ((hAwake * 60 + mAwake));
                totalSleepTimeNeeded += totalInterruptedTime;
            } else {
                totalSleepTimeNeeded += 15;
            }

            const [h, m] = this._desireAwakeHour.split(':').map(Number);
            const desireAwakeMinutes = (h * 60 + m);

            let bedTimeMinutes = desireAwakeMinutes - totalSleepTimeNeeded;

            if (bedTimeMinutes < 0) {
                bedTimeMinutes += 24 * 60;
            }

            const bedTimeHours = Math.floor(bedTimeMinutes / 60);
            const bedTimeMin = bedTimeMinutes % 60;
            const isRecommended = totalCicleHours >= 7;

            return {
                bedTime: `${String(bedTimeHours).padStart(2, '0')}:${String(bedTimeMin).padStart(2, '0')}`,
                isRecommended
            }

        }
    }
</script>
