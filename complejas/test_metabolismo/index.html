<h1>Test de Metabolismo: Rápido o Lento</h1>

<form class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Responde a estas preguntas para estimar si tu metabolismo tiende a ser rápido, intermedio o lento.
    </p>

    <!-- Datos físicos -->
    <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.1em;">Datos físicos</h3>

    <div class="flex">
        <div>
            <label><span>Edad</span><sup>años</sup></label>
            <input type="text" id="age" name="age_input" min="1" max="120" maxlength="3" placeholder="Ej: 32" required>
            <span id="invalid_age" style="display: none;"></span>
        </div>
        <div>
            <label><span>Sexo biológico</span></label>
            <select id="sex" type="select" name="sex_input" required>
                <option disabled selected>Selecciona</option>
                <option value="male">Hombre</option>
                <option value="female">Mujer</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Peso</span><sup>kg</sup></label>
            <input type="text" id="weight" name="weight_input" min="1" maxlength="5" placeholder="Ej: 70" required>
            <span id="invalid_weight" style="display: none;"></span>
        </div>
        <div>
            <label><span>Altura</span><sup>cm</sup></label>
            <input type="text" id="height" name="height_input" min="1" maxlength="3" placeholder="Ej: 170" required>
            <span id="invalid_height" style="display: none;"></span>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Frecuencia cardíaca en reposo</span><sup>ppm</sup></label>
            <input type="text" id="heartRate" name="heartRate_input" min="30" max="150" maxlength="3" placeholder="Ej: 70" required>
            <span id="invalid_heartRate" style="display: none;"></span>
        </div>
        <div>
            <label><span>Temperatura corporal matutina</span><sup>°C</sup></label>
            <input type="text" id="temperature" name="temperature_input" min="34" max="38" maxlength="4" placeholder="Ej: 36,5" required>
            <span id="invalid_temperature" style="display: none;"></span>
        </div>
    </div>

    <!-- Cuestionario -->
    <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.1em;">Cuestionario de sensaciones</h3>

    <div class="flex">
        <div>
            <label><span>1. Suelo tener energía estable a lo largo del día</span></label>
            <select id="q1" type="select" name="q1_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>2. Tengo frío con facilidad, incluso en ambientes templados</span></label>
            <select id="q2" type="select" name="q2_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>3. Tengo hambre o apetito frecuente, especialmente por la mañana</span></label>
            <select id="q3" type="select" name="q3_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>4. Siento fatiga después de las comidas</span></label>
            <select id="q4" type="select" name="q4_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>5. Mi digestión suele ser rápida y ligera</span></label>
            <select id="q5" type="select" name="q5_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>6. Duermo muchas horas, pero me cuesta activarme al despertar</span></label>
            <select id="q6" type="select" name="q6_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>7. Mantengo peso estable aunque coma más de lo habitual</span></label>
            <select id="q7" type="select" name="q7_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>8. Tengo tendencia a aumentar de peso fácilmente</span></label>
            <select id="q8" type="select" name="q8_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0">Nunca</option>
                <option value="1">A veces</option>
                <option value="2">A menudo</option>
                <option value="3">Siempre</option>
            </select>
        </div>
    </div>

    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Ver mi tipo de metabolismo
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<style>
    input:not(:placeholder-shown):invalid,
    select:invalid:not(:focus) {
        border: 1px solid red !important;
    }
</style>

<script type="text/javascript">
    (function() {

        class MetabolismCalculator {
            _age;
            _sex;
            _weight;
            _height;
            _heartRate;
            _temperature;
            _q1; _q2; _q3; _q4; _q5; _q6; _q7; _q8;

            constructor(age, sex, weight, height, heartRate, temperature, q1, q2, q3, q4, q5, q6, q7, q8) {
                this._age = age;
                this._sex = sex;
                this._weight = weight;
                this._height = height;
                this._heartRate = heartRate;
                this._temperature = temperature;
                this._q1 = q1; this._q2 = q2; this._q3 = q3; this._q4 = q4;
                this._q5 = q5; this._q6 = q6; this._q7 = q7; this._q8 = q8;
            }

            get bmi() {
                const heightM = this._height / 100;
                return this._weight / (heightM * heightM);
            }

            get scores() {
                // Base scores from questionnaire
                // Fast metabolism items: 1, 3, 5, 7
                const fastBase = (this._q1 + this._q3 + this._q5 + this._q7) * 3.3;

                // Slow metabolism items: 2, 4, 6, 8
                const slowBase = (this._q2 + this._q4 + this._q6 + this._q8) * 3.3;

                // Calculate adjustments
                let fastAdjustments = 0;
                let slowAdjustments = 0;

                // Age adjustment
                if (this._age > 50) {
                    slowAdjustments += 5;
                }

                // Sex adjustment
                if (this._sex === 'male') {
                    fastAdjustments += 3;
                }

                // BMI adjustments
                const bmi = this.bmi;
                if (bmi < 20) {
                    fastAdjustments += 3;
                } else if (bmi > 27) {
                    slowAdjustments += 3;
                }

                // Heart rate adjustments
                if (this._heartRate < 60) {
                    fastAdjustments += 5;
                } else if (this._heartRate > 80) {
                    slowAdjustments += 5;
                }

                // Temperature adjustments
                if (this._temperature < 36.2) {
                    slowAdjustments += 5;
                } else if (this._temperature >= 36.8) {
                    fastAdjustments += 5;
                }

                // Calculate totals
                const totalFast = fastBase + fastAdjustments;
                const totalSlow = slowBase + slowAdjustments;

                // Normalize to 0-100
                const sum = totalFast + totalSlow;
                const fast0_100 = sum > 0 ? Math.round((totalFast / sum) * 100) : 50;
                const slow0_100 = 100 - fast0_100;

                return {
                    fast: fast0_100,
                    slow: slow0_100
                };
            }

            get classification() {
                const fast = this.scores.fast;

                if (fast >= 65) {
                    return 'rápido';
                } else if (fast >= 40) {
                    return 'intermedio';
                } else {
                    return 'lento';
                }
            }

            get confidence() {
                const scores = this.scores;
                const diff = Math.abs(scores.fast - scores.slow);

                if (diff >= 25) {
                    return 'alta';
                } else if (diff >= 10) {
                    return 'media';
                } else {
                    return 'baja';
                }
            }

            get interpretiveMessage() {
                const classification = this.classification;

                if (classification === 'rápido') {
                    return 'Tu organismo parece funcionar con alta eficiencia y gasto energético; prioriza suficiente ingesta calórica y proteínas.';
                } else if (classification === 'intermedio') {
                    return 'Tienes un metabolismo equilibrado y adaptable; ajusta tu alimentación según tu nivel de actividad.';
                } else {
                    return 'Tu metabolismo parece más conservador; prioriza descanso, ejercicio regular y comidas ligeras pero frecuentes.';
                }
            }

            get warnings() {
                const warnings = [];

                // Temperature warnings
                if (this._temperature < 35.8 || this._temperature > 37.5) {
                    warnings.push('Valor de temperatura atípico; revisa si la medición fue correcta.');
                }

                // Heart rate warnings
                if (this._heartRate < 45 || this._heartRate > 100) {
                    warnings.push('Valor de frecuencia cardíaca atípico; revisa si la medición fue correcta.');
                }

                return warnings;
            }
        }

        //Numeric inputs
        const AGE_INPUT = document.querySelector('#age');
        const WEIGHT_INPUT = document.querySelector('#weight');
        const HEIGHT_INPUT = document.querySelector('#height');
        const HEART_RATE_INPUT = document.querySelector('#heartRate');
        const TEMPERATURE_INPUT = document.querySelector('#temperature');

        //Select inputs
        const SEX_SELECT = document.querySelector('#sex');
        const Q1_SELECT = document.querySelector('#q1');
        const Q2_SELECT = document.querySelector('#q2');
        const Q3_SELECT = document.querySelector('#q3');
        const Q4_SELECT = document.querySelector('#q4');
        const Q5_SELECT = document.querySelector('#q5');
        const Q6_SELECT = document.querySelector('#q6');
        const Q7_SELECT = document.querySelector('#q7');
        const Q8_SELECT = document.querySelector('#q8');

        const FORM = document.querySelector('.form-container');
        const RESULT_BOX = document.querySelector('.result');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Regex to validate decimal numbers
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+\.\d{1,2})$/);
        const INTEGERS_REGEX = new RegExp(/^\d+$/);

        //Helper function to add validation to numeric inputs
        function addNumericValidation(input, isInteger = false) {
            input.addEventListener('input', () => {
                if (input.value === '') {
                    input.setCustomValidity('');
                    return;
                }

                const regex = isInteger ? INTEGERS_REGEX : DECIMALS_REGEX;
                if (!regex.test(input.value)) {
                    const msg = isInteger ? 'Introduce un número entero válido' : 'Introduce un número válido (máximo 2 decimales)';
                    input.setCustomValidity(msg);
                    input.reportValidity();
                    return;
                }

                const value = parseFloat(input.value.replace(',', '.'));
                const min = parseFloat(input.getAttribute('min'));
                const max = parseFloat(input.getAttribute('max'));

                if (value < min || value > max || isNaN(value)) {
                    input.setCustomValidity(`El valor debe estar entre ${min} y ${max}`);
                    input.reportValidity();
                } else {
                    input.setCustomValidity('');
                }
            });
        }

        //Add validation to numeric inputs
        addNumericValidation(AGE_INPUT, true);
        addNumericValidation(WEIGHT_INPUT);
        addNumericValidation(HEIGHT_INPUT, true);
        addNumericValidation(HEART_RATE_INPUT, true);
        addNumericValidation(TEMPERATURE_INPUT);

        //Validate selects
        const SELECTS = document.querySelectorAll('select');
        SELECTS.forEach(select => {
            select.addEventListener('change', () => {
                if (select.value !== "" && select.selectedIndex !== 0) {
                    select.setCustomValidity('');
                }
            });
        });

        FORM.addEventListener('submit', (e) => {
            e.preventDefault();

            //Validate all selects
            let isValid = true;
            SELECTS.forEach(select => {
                if (select.value === "" || select.selectedIndex === 0) {
                    select.setCustomValidity('Por favor, selecciona una opción');
                    select.reportValidity();
                    isValid = false;
                } else {
                    select.setCustomValidity('');
                }
            });

            if (!isValid) return;

            //Parse values
            const age = parseInt(AGE_INPUT.value);
            const sex = SEX_SELECT.value;
            const weight = parseFloat(WEIGHT_INPUT.value.replace(',', '.'));
            const height = parseInt(HEIGHT_INPUT.value);
            const heartRate = parseInt(HEART_RATE_INPUT.value);
            const temperature = parseFloat(TEMPERATURE_INPUT.value.replace(',', '.'));

            const q1 = parseInt(Q1_SELECT.value);
            const q2 = parseInt(Q2_SELECT.value);
            const q3 = parseInt(Q3_SELECT.value);
            const q4 = parseInt(Q4_SELECT.value);
            const q5 = parseInt(Q5_SELECT.value);
            const q6 = parseInt(Q6_SELECT.value);
            const q7 = parseInt(Q7_SELECT.value);
            const q8 = parseInt(Q8_SELECT.value);

            CALCULATE_BTN.innerHTML = 'Calculando...';
            RESULT_BOX.style.visibility = 'hidden';

            const calculator = new MetabolismCalculator(
                age, sex, weight, height, heartRate, temperature,
                q1, q2, q3, q4, q5, q6, q7, q8
            );

            const classification = calculator.classification;
            const scores = calculator.scores;
            const confidence = calculator.confidence;
            const message = calculator.interpretiveMessage;
            const warnings = calculator.warnings;
            const bmi = calculator.bmi;

            setTimeout(() => {
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'center' });
                CALCULATE_BTN.innerHTML = 'Ver mi tipo de metabolismo';
                RESULT_BOX.style.visibility = 'visible';

                let html = `<span>Tu metabolismo estimado es <strong>${classification.toUpperCase()}</strong>.</span><br><br>`;
                html += `<span>Puntuación metabolismo rápido: <strong>${scores.fast} / 100</strong>.<br>`;
                html += `Puntuación metabolismo lento: <strong>${scores.slow} / 100</strong>.<br>`;
                html += `Nivel de confianza: <strong>${confidence}</strong>.</span><br><br>`;
                html += `<span>${message}</span><br><br>`;

                // Show warnings if any
                if (warnings.length > 0) {
                    warnings.forEach(warning => {
                        html += `<span style="color: #FF9800; font-size: 0.9em;">⚠️ ${warning}</span><br>`;
                    });
                    html += '<br>';
                }

                html += `<span style="font-style: italic; font-size: 0.9em;">Los valores fisiológicos son orientativos; no sustituyen una valoración médica. El test refleja patrones generales, no el gasto energético exacto.</span>`;

                RESULT_BOX.innerHTML = html;
            }, 500);
        });

    })();
</script>
