<h1>Calculadora de Densidad Nutricional</h1>

<form class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Calcula el Índice de Densidad Nutricional (IDN) de un alimento según el balance entre nutrientes positivos y negativos por cada 100 kcal.
    </p>

    <div class="flex">
        <div>
            <label><span>Calorías</span><sup>kcal</sup></label>
            <input type="text" id="calories" name="calories_input" min="0" maxlength="6" placeholder="Ej: 250" required>
            <span id="invalid_calories" style="display: none;"></span>
        </div>
    </div>

    <!-- Positive Nutrients Section -->
    <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.1em;">Nutrientes positivos</h3>

    <div class="flex">
        <div>
            <label><span>Proteína</span><sup>g</sup></label>
            <input type="text" id="protein" name="protein_input" min="0" maxlength="6" placeholder="Ej: 25">
            <span id="invalid_protein" style="display: none;"></span>
        </div>
        <div>
            <label><span>Fibra</span><sup>g</sup></label>
            <input type="text" id="fiber" name="fiber_input" min="0" maxlength="6" placeholder="Ej: 8">
            <span id="invalid_fiber" style="display: none;"></span>
        </div>
        <div>
            <label><span>Vitamina A</span><sup>µg</sup></label>
            <input type="text" id="vitaminA" name="vitaminA_input" min="0" maxlength="6" placeholder="Ej: 400">
            <span id="invalid_vitaminA" style="display: none;"></span>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Vitamina C</span><sup>mg</sup></label>
            <input type="text" id="vitaminC" name="vitaminC_input" min="0" maxlength="6" placeholder="Ej: 50">
            <span id="invalid_vitaminC" style="display: none;"></span>
        </div>
        <div>
            <label><span>Vitamina E</span><sup>mg</sup></label>
            <input type="text" id="vitaminE" name="vitaminE_input" min="0" maxlength="6" placeholder="Ej: 5">
            <span id="invalid_vitaminE" style="display: none;"></span>
        </div>
        <div>
            <label><span>Calcio</span><sup>mg</sup></label>
            <input type="text" id="calcium" name="calcium_input" min="0" maxlength="6" placeholder="Ej: 300">
            <span id="invalid_calcium" style="display: none;"></span>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Hierro</span><sup>mg</sup></label>
            <input type="text" id="iron" name="iron_input" min="0" maxlength="6" placeholder="Ej: 5">
            <span id="invalid_iron" style="display: none;"></span>
        </div>
        <div>
            <label><span>Magnesio</span><sup>mg</sup></label>
            <input type="text" id="magnesium" name="magnesium_input" min="0" maxlength="6" placeholder="Ej: 100">
            <span id="invalid_magnesium" style="display: none;"></span>
        </div>
        <div>
            <label><span>Potasio</span><sup>mg</sup></label>
            <input type="text" id="potassium" name="potassium_input" min="0" maxlength="6" placeholder="Ej: 500">
            <span id="invalid_potassium" style="display: none;"></span>
        </div>
    </div>

    <!-- Negative Nutrients Section -->
    <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.1em;">Nutrientes negativos</h3>

    <div class="flex">
        <div>
            <label><span>Grasa saturada</span><sup>g</sup></label>
            <input type="text" id="saturatedFat" name="saturatedFat_input" min="0" maxlength="6" placeholder="Ej: 5">
            <span id="invalid_saturatedFat" style="display: none;"></span>
        </div>
        <div>
            <label><span>Azúcares añadidos</span><sup>g</sup></label>
            <input type="text" id="addedSugars" name="addedSugars_input" min="0" maxlength="6" placeholder="Ej: 10">
            <span id="invalid_addedSugars" style="display: none;"></span>
        </div>
        <div>
            <label><span>Sodio</span><sup>mg</sup></label>
            <input type="text" id="sodium" name="sodium_input" min="0" maxlength="6" placeholder="Ej: 200">
            <span id="invalid_sodium" style="display: none;"></span>
        </div>
    </div>

    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular densidad nutricional
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<style>
    input:not(:placeholder-shown):invalid,
    select:invalid:not(:focus) {
        border: 1px solid red !important;
    }
</style>

<script type="text/javascript">
    (function() {

        class NutritionalDensityCalculator {
            _calories;
            _protein;
            _fiber;
            _vitaminA;
            _vitaminC;
            _vitaminE;
            _calcium;
            _iron;
            _magnesium;
            _potassium;
            _saturatedFat;
            _addedSugars;
            _sodium;

            constructor(calories, protein, fiber, vitaminA, vitaminC, vitaminE, calcium, iron, magnesium, potassium, saturatedFat, addedSugars, sodium) {
                this._calories = calories;
                this._protein = protein;
                this._fiber = fiber;
                this._vitaminA = vitaminA;
                this._vitaminC = vitaminC;
                this._vitaminE = vitaminE;
                this._calcium = calcium;
                this._iron = iron;
                this._magnesium = magnesium;
                this._potassium = potassium;
                this._saturatedFat = saturatedFat;
                this._addedSugars = addedSugars;
                this._sodium = sodium;
            }

            get idn() {
                if (this._calories === 0) return 0;

                // Normalize to 100 kcal
                const factor = 100 / this._calories;

                // Reference values for positive nutrients (VD)
                const VD = {
                    protein: 50,        // g
                    fiber: 25,          // g
                    vitaminA: 5000,     // IU (or 1500 µg RAE)
                    vitaminC: 60,       // mg
                    vitaminE: 20,       // mg
                    calcium: 1000,      // mg
                    iron: 18,           // mg
                    magnesium: 400,     // mg
                    potassium: 3500     // mg
                };

                // Maximum values for negative nutrients (VM)
                const VM = {
                    saturatedFat: 20,   // g
                    addedSugars: 50,    // g
                    sodium: 2400        // mg
                };

                // Calculate % VD for positive nutrients (normalized to 100 kcal)
                // Apply max 100% cap to each nutrient before summing
                const positivePercents =
                    Math.min(100, (this._protein * factor) / VD.protein * 100) +
                    Math.min(100, (this._fiber * factor) / VD.fiber * 100) +
                    Math.min(100, (this._vitaminA * factor) / VD.vitaminA * 100) +
                    Math.min(100, (this._vitaminC * factor) / VD.vitaminC * 100) +
                    Math.min(100, (this._vitaminE * factor) / VD.vitaminE * 100) +
                    Math.min(100, (this._calcium * factor) / VD.calcium * 100) +
                    Math.min(100, (this._iron * factor) / VD.iron * 100) +
                    Math.min(100, (this._magnesium * factor) / VD.magnesium * 100) +
                    Math.min(100, (this._potassium * factor) / VD.potassium * 100);

                // Calculate % VM for negative nutrients (normalized to 100 kcal)
                const negativePercents =
                    ((this._saturatedFat * factor) / VM.saturatedFat * 100) +
                    ((this._addedSugars * factor) / VM.addedSugars * 100) +
                    ((this._sodium * factor) / VM.sodium * 100);

                // IDN = % positives - % negatives
                const idn = positivePercents - negativePercents;

                return Math.round(idn);
            }

            get category() {
                const idn = this.idn;

                if (idn > 100) {
                    return {
                        name: 'Muy denso nutricionalmente',
                        description: 'Excelente alimento. Aporta muchos nutrientes beneficiosos y pocos nutrientes a limitar.',
                        color: '#4CAF50'
                    };
                } else if (idn >= 0) {
                    return {
                        name: 'Densidad nutricional moderada',
                        description: 'Alimento aceptable. Tiene un equilibrio entre nutrientes positivos y negativos.',
                        color: '#FFC107'
                    };
                } else {
                    return {
                        name: 'Baja densidad nutricional',
                        description: 'Alimento poco nutritivo. Aporta más nutrientes a limitar que nutrientes beneficiosos.',
                        color: '#FF5722'
                    };
                }
            }

            getBreakdown() {
                if (this._calories === 0) return { positives: 0, negatives: 0 };

                const factor = 100 / this._calories;

                // Reference values
                const VD = {
                    protein: 50, fiber: 25, vitaminA: 5000, vitaminC: 60, vitaminE: 20,
                    calcium: 1000, iron: 18, magnesium: 400, potassium: 3500
                };
                const VM = {
                    saturatedFat: 20, addedSugars: 50, sodium: 2400
                };

                const positives =
                    Math.min(100, (this._protein * factor) / VD.protein * 100) +
                    Math.min(100, (this._fiber * factor) / VD.fiber * 100) +
                    Math.min(100, (this._vitaminA * factor) / VD.vitaminA * 100) +
                    Math.min(100, (this._vitaminC * factor) / VD.vitaminC * 100) +
                    Math.min(100, (this._vitaminE * factor) / VD.vitaminE * 100) +
                    Math.min(100, (this._calcium * factor) / VD.calcium * 100) +
                    Math.min(100, (this._iron * factor) / VD.iron * 100) +
                    Math.min(100, (this._magnesium * factor) / VD.magnesium * 100) +
                    Math.min(100, (this._potassium * factor) / VD.potassium * 100);

                const negatives =
                    ((this._saturatedFat * factor) / VM.saturatedFat * 100) +
                    ((this._addedSugars * factor) / VM.addedSugars * 100) +
                    ((this._sodium * factor) / VM.sodium * 100);

                return {
                    positives: Math.round(positives * 10) / 10,
                    negatives: Math.round(negatives * 10) / 10
                };
            }
        }

        //Numeric inputs
        const CALORIES_INPUT = document.querySelector('#calories');
        const PROTEIN_INPUT = document.querySelector('#protein');
        const FIBER_INPUT = document.querySelector('#fiber');
        const VITAMIN_A_INPUT = document.querySelector('#vitaminA');
        const VITAMIN_C_INPUT = document.querySelector('#vitaminC');
        const VITAMIN_E_INPUT = document.querySelector('#vitaminE');
        const CALCIUM_INPUT = document.querySelector('#calcium');
        const IRON_INPUT = document.querySelector('#iron');
        const MAGNESIUM_INPUT = document.querySelector('#magnesium');
        const POTASSIUM_INPUT = document.querySelector('#potassium');
        const SATURATED_FAT_INPUT = document.querySelector('#saturatedFat');
        const ADDED_SUGARS_INPUT = document.querySelector('#addedSugars');
        const SODIUM_INPUT = document.querySelector('#sodium');

        const FORM = document.querySelector('.form-container');
        const RESULT_BOX = document.querySelector('.result');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Regex to validate decimal numbers
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+\.\d{1,2})$/);

        //Helper function to add validation to inputs
        function addInputValidation(input) {
            input.addEventListener('input', () => {
                if (input.value === '') {
                    input.setCustomValidity('');
                    return;
                }

                if (!DECIMALS_REGEX.test(input.value)) {
                    input.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                    input.reportValidity();
                    return;
                }

                const value = parseFloat(input.value.replace(',', '.'));
                if (value < 0 || isNaN(value)) {
                    input.setCustomValidity('El valor debe ser mayor o igual a 0');
                    input.reportValidity();
                } else {
                    input.setCustomValidity('');
                }
            });
        }

        //Add validation to all inputs
        [CALORIES_INPUT, PROTEIN_INPUT, FIBER_INPUT, VITAMIN_A_INPUT, VITAMIN_C_INPUT,
         VITAMIN_E_INPUT, CALCIUM_INPUT, IRON_INPUT, MAGNESIUM_INPUT, POTASSIUM_INPUT,
         SATURATED_FAT_INPUT, ADDED_SUGARS_INPUT, SODIUM_INPUT].forEach(input => {
            addInputValidation(input);
        });

        FORM.addEventListener('submit', (e) => {
            e.preventDefault();

            //Validate calories (required)
            if (!CALORIES_INPUT.value || CALORIES_INPUT.value.trim() === '') {
                CALORIES_INPUT.setCustomValidity('Por favor, introduce las calorías del alimento');
                CALORIES_INPUT.reportValidity();
                return;
            }

            if (!DECIMALS_REGEX.test(CALORIES_INPUT.value)) {
                CALORIES_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                CALORIES_INPUT.reportValidity();
                return;
            }

            const calories = parseFloat(CALORIES_INPUT.value.replace(',', '.'));
            if (calories <= 0 || isNaN(calories)) {
                CALORIES_INPUT.setCustomValidity('El valor debe ser mayor a 0');
                CALORIES_INPUT.reportValidity();
                return;
            }

            //Parse other values
            const protein = PROTEIN_INPUT.value && PROTEIN_INPUT.value.trim() !== ''
                ? parseFloat(PROTEIN_INPUT.value.replace(',', '.')) || 0 : 0;
            const fiber = FIBER_INPUT.value && FIBER_INPUT.value.trim() !== ''
                ? parseFloat(FIBER_INPUT.value.replace(',', '.')) || 0 : 0;
            const vitaminA = VITAMIN_A_INPUT.value && VITAMIN_A_INPUT.value.trim() !== ''
                ? parseFloat(VITAMIN_A_INPUT.value.replace(',', '.')) || 0 : 0;
            const vitaminC = VITAMIN_C_INPUT.value && VITAMIN_C_INPUT.value.trim() !== ''
                ? parseFloat(VITAMIN_C_INPUT.value.replace(',', '.')) || 0 : 0;
            const vitaminE = VITAMIN_E_INPUT.value && VITAMIN_E_INPUT.value.trim() !== ''
                ? parseFloat(VITAMIN_E_INPUT.value.replace(',', '.')) || 0 : 0;
            const calcium = CALCIUM_INPUT.value && CALCIUM_INPUT.value.trim() !== ''
                ? parseFloat(CALCIUM_INPUT.value.replace(',', '.')) || 0 : 0;
            const iron = IRON_INPUT.value && IRON_INPUT.value.trim() !== ''
                ? parseFloat(IRON_INPUT.value.replace(',', '.')) || 0 : 0;
            const magnesium = MAGNESIUM_INPUT.value && MAGNESIUM_INPUT.value.trim() !== ''
                ? parseFloat(MAGNESIUM_INPUT.value.replace(',', '.')) || 0 : 0;
            const potassium = POTASSIUM_INPUT.value && POTASSIUM_INPUT.value.trim() !== ''
                ? parseFloat(POTASSIUM_INPUT.value.replace(',', '.')) || 0 : 0;
            const saturatedFat = SATURATED_FAT_INPUT.value && SATURATED_FAT_INPUT.value.trim() !== ''
                ? parseFloat(SATURATED_FAT_INPUT.value.replace(',', '.')) || 0 : 0;
            const addedSugars = ADDED_SUGARS_INPUT.value && ADDED_SUGARS_INPUT.value.trim() !== ''
                ? parseFloat(ADDED_SUGARS_INPUT.value.replace(',', '.')) || 0 : 0;
            const sodium = SODIUM_INPUT.value && SODIUM_INPUT.value.trim() !== ''
                ? parseFloat(SODIUM_INPUT.value.replace(',', '.')) || 0 : 0;

            CALCULATE_BTN.innerHTML = 'Calculando...';
            RESULT_BOX.style.visibility = 'hidden';

            const calculator = new NutritionalDensityCalculator(
                calories, protein, fiber, vitaminA, vitaminC, vitaminE, calcium,
                iron, magnesium, potassium, saturatedFat, addedSugars, sodium
            );

            const idn = calculator.idn;
            const category = calculator.category;
            const breakdown = calculator.getBreakdown();

            setTimeout(() => {
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'center' });
                CALCULATE_BTN.innerHTML = 'Calcular densidad nutricional';
                RESULT_BOX.style.visibility = 'visible';

                let html = `<span>Índice de Densidad Nutricional (IDN) por 100 kcal: <strong>${idn}</strong></span><br><br>`;
                html += `<span><strong>${category.name}</strong></span><br>`;
                html += `<span>${category.description}</span><br><br>`;

                html += `<span style="font-size: 0.9em;">% VD positivos (por 100 kcal): <strong>${breakdown.positives.toString().replace('.', ',')} %</strong></span><br>`;
                html += `<span style="font-size: 0.9em;">% VM negativos (por 100 kcal): <strong>${breakdown.negatives.toString().replace('.', ',')} %</strong></span><br><br>`;

                html += `<span style="font-style: italic; font-size: 0.85em;">Nota: El IDN se calcula como la suma de % de Valores Diarios (VD) de nutrientes positivos menos la suma de % de Valores Máximos (VM) de nutrientes negativos, normalizados a 100 kcal. IDN > 100 indica muy alta densidad, 0-100 densidad moderada, y < 0 baja densidad.</span>`;

                RESULT_BOX.innerHTML = html;
            }, 500);
        });

    })();
</script>
