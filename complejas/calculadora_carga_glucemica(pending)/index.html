<h1>Calculadora de Carga Glucémica de Comidas</h1>

<div class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Añade los alimentos de tu comida uno por uno. El resultado mostrará la carga glucémica total.
    </p>

    <div class="flex">
        <div>
            <label><span>Nombre del alimento (opcional)</span></label>
            <input type="text" id="nombre" placeholder="Ej: Arroz integral">
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Carbohidratos totales por porción (g)</span></label>
            <input type="number" id="carbohidratos" min="0" step="0.1" placeholder="0">
        </div>
        <div>
            <label><span>Fibra por porción (g)</span></label>
            <input type="number" id="fibra" min="0" step="0.1" value="0">
        </div>
        <div>
            <label><span>Azúcares libres por porción (g)</span></label>
            <input type="number" id="azucares" min="0" step="0.1" value="0">
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Grasa por porción (g)</span></label>
            <input type="number" id="grasa" min="0" step="0.1" value="0">
        </div>
        <div>
            <label><span>Proteína por porción (g)</span></label>
            <input type="number" id="proteina" min="0" step="0.1" value="0">
        </div>
    </div>

    <div style="margin-top: 20px; margin-bottom: 15px;">
        <label style="font-weight: bold; margin-bottom: 10px; display: block;">Señales de forma/procesado (marcar las que apliquen):</label>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
            <label style="font-weight: normal;"><input type="checkbox" id="liquido"> Líquido/bebida</label>
            <label style="font-weight: normal;"><input type="checkbox" id="zumo"> Zumo/bebida azucarada</label>
            <label style="font-weight: normal;"><input type="checkbox" id="molienda"> Molienda/extrusión fina</label>
            <label style="font-weight: normal;"><input type="checkbox" id="estructuraIntacta"> Estructura intacta/al dente</label>
            <label style="font-weight: normal;"><input type="checkbox" id="cocinadoEnfriado"> Cocinado y enfriado ≥12h</label>
            <label style="font-weight: normal;"><input type="checkbox" id="madura"> Madura/sobre-madura</label>
            <label style="font-weight: normal;"><input type="checkbox" id="acido"> Con ácido (vinagre/limón)</label>
            <label style="font-weight: normal;"><input type="checkbox" id="matrizLactea"> Matriz láctea predominante</label>
            <label style="font-weight: normal;"><input type="checkbox" id="legumbre"> Legumbre predominante</label>
            <label style="font-weight: normal;"><input type="checkbox" id="frutaEntera"> Fruta entera (no zumo)</label>
            <label style="font-weight: normal;"><input type="checkbox" id="fibraViscosa"> Fibra viscosa añadida</label>
        </div>
    </div>

    <button type="button" id="add-btn" class="btn-calculate" style="background-color: #4CAF50;">
        Añadir alimento a la comida
    </button>

    <div id="lista-alimentos" style="margin-top: 20px; display: none;">
        <h3>Alimentos añadidos (<span id="num-alimentos">0</span>):</h3>
        <div id="alimentos-container" style="margin-bottom: 15px;"></div>
        <button type="button" id="calculate-btn" class="btn-calculate">
            Calcular Carga Glucémica Total
        </button>
    </div>
</div>

<p class="result" style="visibility: hidden;"></p>

<script type="text/javascript">
    (function() {

        class GlycemicLoadCalculator {
            constructor() {
                this.foods = [];
            }

            addFood(food) {
                const availableCho = Math.max(0, food.totalCarbs - food.fiber);
                const estimatedGI = this.calculateEstimatedGI(food, availableCho);
                const individualGL = (estimatedGI * availableCho) / 100;

                this.foods.push({
                    ...food,
                    availableCho,
                    estimatedGI,
                    individualGL
                });
            }

            calculateEstimatedGI(food, availableCho) {
                let baseGI = 70;

                if (food.signals.liquid) baseGI += 20;
                if (food.signals.juice) baseGI += 10;
                if (food.signals.grinding) baseGI += 10;
                if (food.signals.intactStructure) baseGI -= 10;
                if (food.signals.cookedChilled) baseGI -= 10;
                if (food.signals.ripe) baseGI += 5;
                if (food.signals.acidic) baseGI -= 5;
                if (food.signals.dairyMatrix) baseGI -= 10;
                if (food.signals.legume) baseGI -= 10;
                if (food.signals.wholeFruit) baseGI -= 5;
                if (food.signals.viscousFiber) baseGI -= 10;

                const ratio = food.freeSugars / Math.max(1, availableCho);
                if (ratio >= 0.60) {
                    baseGI += 10;
                } else if (ratio >= 0.30) {
                    baseGI += 5;
                }

                const fatAdjustment = Math.min(10, Math.floor(food.fat / 10) * 5);
                baseGI -= fatAdjustment;

                const proteinAdjustment = Math.min(10, Math.floor(food.protein / 15) * 5);
                baseGI -= proteinAdjustment;

                return Math.max(0, Math.min(100, Math.round(baseGI)));
            }

            calculateResult() {
                if (this.foods.length === 0) {
                    return { error: 'No hay alimentos añadidos' };
                }

                const totalGL = this.foods.reduce((sum, f) => sum + f.individualGL, 0);
                const totalAvailableCho = this.foods.reduce((sum, f) => sum + f.availableCho, 0);

                let averageGI = null;
                if (totalAvailableCho > 0) {
                    const sumGIxCho = this.foods.reduce((sum, f) => sum + (f.estimatedGI * f.availableCho), 0);
                    averageGI = Math.round(sumGIxCho / totalAvailableCho);
                }

                let category;
                if (totalGL < 10) {
                    category = 'baja';
                } else if (totalGL <= 20) {
                    category = 'media';
                } else {
                    category = 'alta';
                }

                return {
                    totalGL: Math.round(totalGL * 10) / 10,
                    averageGI,
                    category
                };
            }

            clear() {
                this.foods = [];
            }
        }

        const calculator = new GlycemicLoadCalculator();

        const ADD_BTN = document.querySelector('#add-btn');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');
        const RESULT_BOX = document.querySelector('.result');
        const FOOD_LIST = document.querySelector('#lista-alimentos');
        const NUM_FOODS = document.querySelector('#num-alimentos');
        const FOODS_CONTAINER = document.querySelector('#alimentos-container');

        function clearForm() {
            document.getElementById('nombre').value = '';
            document.getElementById('carbohidratos').value = '';
            document.getElementById('fibra').value = '0';
            document.getElementById('azucares').value = '0';
            document.getElementById('grasa').value = '0';
            document.getElementById('proteina').value = '0';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function updateList() {
            if (calculator.foods.length === 0) {
                FOOD_LIST.style.display = 'none';
                return;
            }

            FOOD_LIST.style.display = 'block';
            NUM_FOODS.textContent = calculator.foods.length;

            FOODS_CONTAINER.innerHTML = calculator.foods.map((f, i) =>
                `<div style="background: #f5f5f5; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                    <strong>${i + 1}. ${f.name}</strong> -
                    CHO: ${f.totalCarbs}g, Fibra: ${f.fiber}g |
                    IG estimado: ${f.estimatedGI} | CG: ${f.individualGL.toFixed(1)}
                </div>`
            ).join('');
        }

        ADD_BTN.addEventListener('click', () => {
            const carbs = parseFloat(document.getElementById('carbohidratos').value);

            if (!carbs && carbs !== 0) {
                alert('Por favor, introduce los carbohidratos totales del alimento.');
                return;
            }

            if (carbs < 0) {
                alert('Los valores deben ser mayores o iguales a 0.');
                return;
            }

            const food = {
                name: document.getElementById('nombre').value || 'Alimento sin nombre',
                totalCarbs: carbs,
                fiber: parseFloat(document.getElementById('fibra').value) || 0,
                freeSugars: parseFloat(document.getElementById('azucares').value) || 0,
                fat: parseFloat(document.getElementById('grasa').value) || 0,
                protein: parseFloat(document.getElementById('proteina').value) || 0,
                signals: {
                    liquid: document.getElementById('liquido').checked,
                    juice: document.getElementById('zumo').checked,
                    grinding: document.getElementById('molienda').checked,
                    intactStructure: document.getElementById('estructuraIntacta').checked,
                    cookedChilled: document.getElementById('cocinadoEnfriado').checked,
                    ripe: document.getElementById('madura').checked,
                    acidic: document.getElementById('acido').checked,
                    dairyMatrix: document.getElementById('matrizLactea').checked,
                    legume: document.getElementById('legumbre').checked,
                    wholeFruit: document.getElementById('frutaEntera').checked,
                    viscousFiber: document.getElementById('fibraViscosa').checked
                }
            };

            calculator.addFood(food);
            updateList();
            clearForm();
            RESULT_BOX.style.visibility = 'hidden';
        });

        CALCULATE_BTN.addEventListener('click', () => {
            const result = calculator.calculateResult();

            if (result.error) {
                alert(result.error);
                return;
            }

            const categoryText = result.category.charAt(0).toUpperCase() + result.category.slice(1);

            let html = `<strong>La carga glucémica total de esta comida es ${result.totalGL} (${categoryText}).</strong>`;

            if (result.averageGI !== null) {
                html += `<br><br>IG medio estimado (ponderado): ${result.averageGI}.`;
            }

            html += `<br><br><span style="font-style: italic; font-size: 0.9em;">Nota: El IG se ha estimado mediante reglas sin tablas; puede variar según cocción, madurez y marca. El IG medio de comidas mixtas es aproximado.</span>`;

            RESULT_BOX.innerHTML = html;

            setTimeout(() => {
                RESULT_BOX.style.visibility = 'visible';
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        });

    })();
    </script>
