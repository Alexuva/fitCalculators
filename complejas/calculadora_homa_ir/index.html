<h1>Calculadora HOMA-IR</h1>

<form class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Calcula tu índice de resistencia a la insulina (HOMA-IR) a partir de tus valores de glucosa e insulina en ayunas.
    </p>

    <div class="flex">
        <div>
            <label><span>Glucosa en ayunas</span></label>
            <input type="text" id="glucose" name="glucose_input" min="0" maxlength="6" placeholder="Ej: 95" required>
            <span id="invalid_glucose" style="display: none;"></span>
        </div>
        <div>
            <label><span>Unidad de glucosa</span></label>
            <select id="glucoseUnit" type="select" name="glucoseUnit_input" required>
                <option disabled selected>Selecciona</option>
                <option value="mg/dL">mg/dL</option>
                <option value="mmol/L">mmol/L</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Insulina en ayunas</span><sup>μU/mL o mUI/L</sup></label>
            <input type="text" id="insulin" name="insulin_input" min="0" maxlength="6" placeholder="Ej: 8" required>
            <span id="invalid_insulin" style="display: none;"></span>
        </div>
    </div>

    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular HOMA-IR
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<style>
    input:not(:placeholder-shown):invalid,
    select:invalid:not(:focus) {
        border: 1px solid red !important;
    }
</style>

<script type="text/javascript">
    (function() {

        class HomaIRCalculator {
            _glucose;
            _insulin;
            _glucoseUnit;

            constructor(glucose, insulin, glucoseUnit) {
                this._glucose = glucose;
                this._insulin = insulin;
                this._glucoseUnit = glucoseUnit;
            }

            get homaIR() {
                let glucoseInMgDL = this._glucose;

                // Convertir a mg/dL si está en mmol/L
                if (this._glucoseUnit === 'mmol/L') {
                    glucoseInMgDL = this._glucose * 18.018;
                }

                // Fórmula HOMA-IR: (Glucosa en mg/dL × Insulina en μU/mL) / 405
                const homa = (glucoseInMgDL * this._insulin) / 405;

                return Math.round(homa * 100) / 100;
            }

            get category() {
                const homa = this.homaIR;

                if (homa < 1) {
                    return {
                        name: 'Sensibilidad óptima a la insulina',
                        description: 'Excelente. Tu cuerpo responde muy bien a la insulina.',
                        color: '#4CAF50',
                        recommendation: 'Mantén tus hábitos saludables: dieta equilibrada, ejercicio regular y buen descanso.'
                    };
                } else if (homa < 2) {
                    return {
                        name: 'Sensibilidad normal a la insulina',
                        description: 'Bien. Tu sensibilidad a la insulina está dentro de lo normal.',
                        color: '#8BC34A',
                        recommendation: 'Mantén un estilo de vida saludable para prevenir la resistencia a la insulina.'
                    };
                } else if (homa < 3) {
                    return {
                        name: 'Resistencia leve a la insulina',
                        description: 'Atención. Comienzas a mostrar signos de resistencia a la insulina.',
                        color: '#FFC107',
                        recommendation: 'Considera mejorar tu dieta (reducir azúcares y harinas refinadas), aumentar la actividad física y controlar el estrés.'
                    };
                } else if (homa < 5) {
                    return {
                        name: 'Resistencia moderada a la insulina',
                        description: 'Preocupante. Tienes resistencia moderada a la insulina.',
                        color: '#FF9800',
                        recommendation: 'Consulta con un endocrino. Necesitas cambios significativos en dieta y ejercicio. Considera ayuno intermitente y ejercicio de fuerza.'
                    };
                } else {
                    return {
                        name: 'Resistencia alta a la insulina',
                        description: 'Alerta. Resistencia elevada a la insulina. Riesgo de diabetes tipo 2.',
                        color: '#F44336',
                        recommendation: 'Urgente: Consulta con un endocrinólogo. Requiere intervención médica y cambios drásticos en el estilo de vida.'
                    };
                }
            }

            get insulinSensitivity() {
                // Índice de sensibilidad a la insulina (inverso de HOMA-IR)
                const sensitivity = 1 / this.homaIR;
                return Math.round(sensitivity * 1000) / 1000;
            }

            get betaCellFunction() {
                let glucoseInMgDL = this._glucose;

                if (this._glucoseUnit === 'mmol/L') {
                    glucoseInMgDL = this._glucose * 18.018;
                }

                // Función de célula beta HOMA-B: (360 × Insulina) / (Glucosa - 63)
                if (glucoseInMgDL <= 63) {
                    return null; // No se puede calcular con glucosa muy baja
                }

                const homaB = (360 * this._insulin) / (glucoseInMgDL - 63);
                return Math.round(homaB * 10) / 10;
            }
        }

        //Numeric inputs
        const GLUCOSE_INPUT = document.querySelector('#glucose');
        const INSULIN_INPUT = document.querySelector('#insulin');
        const GLUCOSE_UNIT_SELECT = document.querySelector('#glucoseUnit');

        const FORM = document.querySelector('.form-container');
        const RESULT_BOX = document.querySelector('.result');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Regex to validate decimal numbers
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+\.\d{1,2})$/);

        //Validate glucose input
        GLUCOSE_INPUT.addEventListener('input', () => {
            if (GLUCOSE_INPUT.value === '') {
                GLUCOSE_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(GLUCOSE_INPUT.value)) {
                GLUCOSE_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                GLUCOSE_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(GLUCOSE_INPUT.value.replace(',', '.'));
            if (value <= 0 || isNaN(value)) {
                GLUCOSE_INPUT.setCustomValidity('El valor debe ser mayor a 0');
                GLUCOSE_INPUT.reportValidity();
            } else {
                GLUCOSE_INPUT.setCustomValidity('');
            }
        });

        //Validate insulin input
        INSULIN_INPUT.addEventListener('input', () => {
            if (INSULIN_INPUT.value === '') {
                INSULIN_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(INSULIN_INPUT.value)) {
                INSULIN_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                INSULIN_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(INSULIN_INPUT.value.replace(',', '.'));
            if (value <= 0 || isNaN(value)) {
                INSULIN_INPUT.setCustomValidity('El valor debe ser mayor a 0');
                INSULIN_INPUT.reportValidity();
            } else {
                INSULIN_INPUT.setCustomValidity('');
            }
        });

        //Validate select
        GLUCOSE_UNIT_SELECT.addEventListener('change', () => {
            if (GLUCOSE_UNIT_SELECT.value !== "" && GLUCOSE_UNIT_SELECT.selectedIndex !== 0) {
                GLUCOSE_UNIT_SELECT.setCustomValidity('');
            }
        });

        FORM.addEventListener('submit', (e) => {
            e.preventDefault();

            //Validate glucose unit select
            if (GLUCOSE_UNIT_SELECT.value === "" || GLUCOSE_UNIT_SELECT.selectedIndex === 0) {
                GLUCOSE_UNIT_SELECT.setCustomValidity('Por favor, selecciona una unidad');
                GLUCOSE_UNIT_SELECT.reportValidity();
                return;
            }

            //Validate glucose (required)
            if (!GLUCOSE_INPUT.value || GLUCOSE_INPUT.value.trim() === '') {
                GLUCOSE_INPUT.setCustomValidity('Por favor, introduce el valor de glucosa');
                GLUCOSE_INPUT.reportValidity();
                return;
            }

            if (!DECIMALS_REGEX.test(GLUCOSE_INPUT.value)) {
                GLUCOSE_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                GLUCOSE_INPUT.reportValidity();
                return;
            }

            const glucose = parseFloat(GLUCOSE_INPUT.value.replace(',', '.'));
            if (glucose <= 0 || isNaN(glucose)) {
                GLUCOSE_INPUT.setCustomValidity('El valor debe ser mayor a 0');
                GLUCOSE_INPUT.reportValidity();
                return;
            }

            //Validate insulin (required)
            if (!INSULIN_INPUT.value || INSULIN_INPUT.value.trim() === '') {
                INSULIN_INPUT.setCustomValidity('Por favor, introduce el valor de insulina');
                INSULIN_INPUT.reportValidity();
                return;
            }

            if (!DECIMALS_REGEX.test(INSULIN_INPUT.value)) {
                INSULIN_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                INSULIN_INPUT.reportValidity();
                return;
            }

            const insulin = parseFloat(INSULIN_INPUT.value.replace(',', '.'));
            if (insulin <= 0 || isNaN(insulin)) {
                INSULIN_INPUT.setCustomValidity('El valor debe ser mayor a 0');
                INSULIN_INPUT.reportValidity();
                return;
            }

            const glucoseUnit = GLUCOSE_UNIT_SELECT.value;

            CALCULATE_BTN.innerHTML = 'Calculando...';
            RESULT_BOX.style.visibility = 'hidden';

            const calculator = new HomaIRCalculator(glucose, insulin, glucoseUnit);
            const homaIR = calculator.homaIR;
            const category = calculator.category;
            const sensitivity = calculator.insulinSensitivity;
            const betaCell = calculator.betaCellFunction;

            setTimeout(() => {
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'center' });
                CALCULATE_BTN.innerHTML = 'Calcular HOMA-IR';
                RESULT_BOX.style.visibility = 'visible';

                let html = `<span>El índice HOMA-IR es <strong>${homaIR.toString().replace('.', ',')}</strong>.</span><br><br>`;
                html += `<span>Clasificación: <strong>${category.name}</strong>.</span><br><br>`;
                html += `<span style="font-style: italic; font-size: 0.9em;">Solo orientativo; no sustituye la valoración médica.</span>`;

                RESULT_BOX.innerHTML = html;
            }, 500);
        });

    })();
</script>
