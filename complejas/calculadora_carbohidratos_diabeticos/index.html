<form class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Calcula las unidades de insulina rápida necesarias según tu ratio de insulina:carbohidratos y el impacto glucémico estimado.
    </p>

    <div class="flex">
        <div>
            <label><span>Carbohidratos totales</span><sup>g</sup></label>
            <input type="text" id="carbs" name="carbs_input" min="0" maxlength="6" placeholder="Ej: 50" required>
            <span id="invalid_carbs" style="display: none;"></span>
        </div>
        <div>
            <label><span>Fibra</span><sup>g</sup></label>
            <input type="text" id="fiber" name="fiber_input" min="0" maxlength="6" placeholder="Ej: 5">
            <span id="invalid_fiber" style="display: none;"></span>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Proteína</span><sup>g</sup></label>
            <input type="text" id="protein" name="protein_input" min="0" maxlength="6" placeholder="Ej: 20">
            <span id="invalid_protein" style="display: none;"></span>
        </div>
        <div>
            <label><span>Grasa</span><sup>g</sup></label>
            <input type="text" id="fat" name="fat_input" min="0" maxlength="6" placeholder="Ej: 10">
            <span id="invalid_fat" style="display: none;"></span>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Ratio insulina:carbohidratos (1:X)</span></label>
            <input type="text" id="ratio" name="ratio_input" min="1" maxlength="3" placeholder="Ej: 10" required>
            <span id="invalid_ratio" style="display: none;"></span>
            <span style="font-size: 0.85em; color: #666; display: block; margin-top: 5px;">
                Introduce el número de gramos de carbohidratos que cubre 1 unidad de insulina
            </span>
        </div>
    </div>

    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular dosis de insulina
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<style>
    input:not(:placeholder-shown):invalid,
    select:invalid:not(:focus) {
        border: 1px solid red !important;
    }
</style>

<script type="text/javascript">
    (function() {

        class DiabetesCalculator {
            _totalCarbs;
            _fiber;
            _protein;
            _fat;
            _ratio;

            constructor(totalCarbs, fiber, protein, fat, ratio) {
                this._totalCarbs = totalCarbs;
                this._fiber = fiber;
                this._protein = protein;
                this._fat = fat;
                this._ratio = ratio;
            }

            get availableCarbs() {
                return Math.max(0, this._totalCarbs - this._fiber);
            }

            get insulinUnits() {
                const baseUnits = this.availableCarbs / this._ratio;

                // Ajuste por proteína (58% se convierte a glucosa)
                const proteinEffect = (this._protein * 0.58) / this._ratio;

                // Ajuste por grasa (10% se convierte a glucosa)
                const fatEffect = (this._fat * 0.1) / this._ratio;

                const totalUnits = baseUnits + proteinEffect + fatEffect;

                return Math.round(totalUnits * 10) / 10;
            }

            get immediateInsulin() {
                const baseUnits = this.availableCarbs / this._ratio;
                return Math.round(baseUnits * 10) / 10;
            }

            get delayedInsulin() {
                return Math.round((this.insulinUnits - this.immediateInsulin) * 10) / 10;
            }

            get glycemicImpact() {
                const availableCarbs = this.availableCarbs;

                // Estimación del impacto glucémico
                let impact = availableCarbs * 3; // mg/dL aproximados por gramo de CHO

                // Reducción por grasa (ralentiza absorción)
                if (this._fat > 15) {
                    impact *= 0.8;
                } else if (this._fat > 10) {
                    impact *= 0.9;
                }

                // Reducción por proteína
                if (this._protein > 20) {
                    impact *= 0.9;
                }

                return Math.round(impact);
            }

            get absorptionSpeed() {
                const fatRatio = this._fat / Math.max(1, this.availableCarbs);
                const proteinRatio = this._protein / Math.max(1, this.availableCarbs);

                if (fatRatio > 1 || proteinRatio > 1.5) {
                    return 'Lenta (3-4 horas)';
                } else if (fatRatio > 0.5 || proteinRatio > 0.8) {
                    return 'Media (2-3 horas)';
                } else {
                    return 'Rápida (1-2 horas)';
                }
            }
        }

        //Numeric inputs
        const CARBS_INPUT = document.querySelector('#carbs');
        const FIBER_INPUT = document.querySelector('#fiber');
        const PROTEIN_INPUT = document.querySelector('#protein');
        const FAT_INPUT = document.querySelector('#fat');
        const RATIO_INPUT = document.querySelector('#ratio');

        const FORM = document.querySelector('.form-container');
        const RESULT_BOX = document.querySelector('.result');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        //Regex to validate decimal numbers
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+\.\d{1,2})$/);
        const INTEGERS_REGEX = new RegExp(/^\d+$/);

        //Validate carbs input
        CARBS_INPUT.addEventListener('input', () => {
            if (CARBS_INPUT.value === '') {
                CARBS_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(CARBS_INPUT.value)) {
                CARBS_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                CARBS_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(CARBS_INPUT.value.replace(',', '.'));
            if (value < 0 || isNaN(value)) {
                CARBS_INPUT.setCustomValidity('El valor debe ser mayor o igual a 0');
                CARBS_INPUT.reportValidity();
            } else {
                CARBS_INPUT.setCustomValidity('');
            }
        });

        //Validate fiber input
        FIBER_INPUT.addEventListener('input', () => {
            if (FIBER_INPUT.value === '') {
                FIBER_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(FIBER_INPUT.value)) {
                FIBER_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                FIBER_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(FIBER_INPUT.value.replace(',', '.'));
            if (value < 0 || isNaN(value)) {
                FIBER_INPUT.setCustomValidity('El valor debe ser mayor o igual a 0');
                FIBER_INPUT.reportValidity();
            } else {
                FIBER_INPUT.setCustomValidity('');
            }
        });

        //Validate protein input
        PROTEIN_INPUT.addEventListener('input', () => {
            if (PROTEIN_INPUT.value === '') {
                PROTEIN_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(PROTEIN_INPUT.value)) {
                PROTEIN_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                PROTEIN_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(PROTEIN_INPUT.value.replace(',', '.'));
            if (value < 0 || isNaN(value)) {
                PROTEIN_INPUT.setCustomValidity('El valor debe ser mayor o igual a 0');
                PROTEIN_INPUT.reportValidity();
            } else {
                PROTEIN_INPUT.setCustomValidity('');
            }
        });

        //Validate fat input
        FAT_INPUT.addEventListener('input', () => {
            if (FAT_INPUT.value === '') {
                FAT_INPUT.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(FAT_INPUT.value)) {
                FAT_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                FAT_INPUT.reportValidity();
                return;
            }

            const value = parseFloat(FAT_INPUT.value.replace(',', '.'));
            if (value < 0 || isNaN(value)) {
                FAT_INPUT.setCustomValidity('El valor debe ser mayor o igual a 0');
                FAT_INPUT.reportValidity();
            } else {
                FAT_INPUT.setCustomValidity('');
            }
        });

        //Validate ratio input
        RATIO_INPUT.addEventListener('input', () => {
            if (RATIO_INPUT.value === '') {
                RATIO_INPUT.setCustomValidity('');
                return;
            }

            if (!INTEGERS_REGEX.test(RATIO_INPUT.value)) {
                RATIO_INPUT.setCustomValidity('Introduce un número entero válido');
                RATIO_INPUT.reportValidity();
                return;
            }

            const value = parseInt(RATIO_INPUT.value);
            if (value < 1 || isNaN(value)) {
                RATIO_INPUT.setCustomValidity('El valor debe ser mayor o igual a 1');
                RATIO_INPUT.reportValidity();
            } else {
                RATIO_INPUT.setCustomValidity('');
            }
        });

        FORM.addEventListener('submit', (e) => {
            e.preventDefault();

            //Validate carbs (required)
            if (!CARBS_INPUT.value || CARBS_INPUT.value.trim() === '') {
                CARBS_INPUT.setCustomValidity('Por favor, introduce los carbohidratos totales');
                CARBS_INPUT.reportValidity();
                return;
            }

            if (!DECIMALS_REGEX.test(CARBS_INPUT.value)) {
                CARBS_INPUT.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                CARBS_INPUT.reportValidity();
                return;
            }

            const totalCarbs = parseFloat(CARBS_INPUT.value.replace(',', '.'));
            if (totalCarbs < 0 || isNaN(totalCarbs)) {
                CARBS_INPUT.setCustomValidity('El valor debe ser mayor o igual a 0');
                CARBS_INPUT.reportValidity();
                return;
            }

            //Validate ratio (required)
            if (!RATIO_INPUT.value || RATIO_INPUT.value.trim() === '') {
                RATIO_INPUT.setCustomValidity('Por favor, introduce tu ratio de insulina:carbohidratos');
                RATIO_INPUT.reportValidity();
                return;
            }

            if (!INTEGERS_REGEX.test(RATIO_INPUT.value)) {
                RATIO_INPUT.setCustomValidity('Introduce un número entero válido');
                RATIO_INPUT.reportValidity();
                return;
            }

            const ratio = parseInt(RATIO_INPUT.value);
            if (ratio < 1 || isNaN(ratio)) {
                RATIO_INPUT.setCustomValidity('El valor debe ser mayor o igual a 1');
                RATIO_INPUT.reportValidity();
                return;
            }

            //Parse other values with validation
            const fiber = FIBER_INPUT.value && FIBER_INPUT.value.trim() !== ''
                ? parseFloat(FIBER_INPUT.value.replace(',', '.')) || 0
                : 0;
            const protein = PROTEIN_INPUT.value && PROTEIN_INPUT.value.trim() !== ''
                ? parseFloat(PROTEIN_INPUT.value.replace(',', '.')) || 0
                : 0;
            const fat = FAT_INPUT.value && FAT_INPUT.value.trim() !== ''
                ? parseFloat(FAT_INPUT.value.replace(',', '.')) || 0
                : 0;

            CALCULATE_BTN.innerHTML = 'Calculando...';
            RESULT_BOX.style.visibility = 'hidden';

            const calculator = new DiabetesCalculator(totalCarbs, fiber, protein, fat, ratio);

            setTimeout(() => {
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'center' });
                CALCULATE_BTN.innerHTML = 'Calcular dosis de insulina';
                RESULT_BOX.style.visibility = 'visible';

                let html = `<span>Carbohidratos disponibles: <strong>${calculator.availableCarbs} g</strong></span><br><br>`;
                html += `<span>Insulina rápida inmediata: <strong>${calculator.immediateInsulin} unidades</strong></span><br>`;

                if (calculator.delayedInsulin > 0) {
                    html += `<span>Insulina adicional (por proteína/grasa): <strong>${calculator.delayedInsulin} unidades</strong></span><br>`;
                    html += `<span>Total estimado: <strong>${calculator.insulinUnits} unidades</strong></span><br><br>`;
                } else {
                    html += `<br>`;
                }

                html += `<span>Impacto glucémico estimado: <strong>+${calculator.glycemicImpact} mg/dL</strong></span><br>`;
                html += `<span>Velocidad de absorción: <strong>${calculator.absorptionSpeed}</strong></span><br><br>`;
                html += `<span style="font-style: italic; font-size: 0.9em;">Nota: Estos cálculos son estimaciones. Consulta con tu endocrino y ajusta según tu experiencia personal y monitorización continua.</span>`;

                RESULT_BOX.innerHTML = html;
            }, 500);
        });

    })();
</script>
