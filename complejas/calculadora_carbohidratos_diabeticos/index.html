<form class="form-container">
    <p style="margin-bottom: 20px; text-align: center; font-style: italic;">
        Calcula los carbohidratos efectivos de tu comida para el control glucémico y conviértelos en raciones/intercambios.
    </p>

    <!-- Configuration Section -->
    <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 1.1em;">Configuración</h3>

    <div class="flex">
        <div>
            <label><span>Región de etiquetado</span></label>
            <select id="region" type="select" name="region_input" required>
                <option disabled selected>Selecciona</option>
                <option value="UE">UE (carbohidratos excluyen fibra)</option>
                <option value="US">EE. UU./otros (carbohidratos incluyen fibra)</option>
            </select>
        </div>
        <div>
            <label><span>Perfil de conteo</span></label>
            <select id="profile" type="select" name="profile_input" required>
                <option disabled selected>Selecciona</option>
                <option value="ADA">ADA estándar</option>
                <option value="Conservador">Conservador</option>
            </select>
        </div>
    </div>

    <div class="flex">
        <div>
            <label><span>Tamaño de ración</span></label>
            <select id="rationSize" type="select" name="rationSize_input" required>
                <option disabled selected>Selecciona</option>
                <option value="10">10 g (típico en España)</option>
                <option value="15">15 g (estándar internacional)</option>
            </select>
        </div>
        <div>
            <label><span>Redondeo de raciones</span></label>
            <select id="rounding" type="select" name="rounding_input" required>
                <option disabled selected>Selecciona</option>
                <option value="0.1">A 0,1 raciones</option>
                <option value="0.5">A 0,5 raciones</option>
                <option value="1">Al entero más cercano</option>
            </select>
        </div>
    </div>

    <!-- Foods Section -->
    <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.1em;">Alimentos de la comida</h3>

    <div id="foodsContainer"></div>

    <button type="button" id="addFoodBtn" class="btn-calculate" style="background-color: #4CAF50; margin-top: 10px; margin-bottom: 20px;">
        + Agregar otro alimento
    </button>

    <button id="calculate-btn" type="submit" value="Calcular" class="btn-calculate">
        Calcular carbohidratos efectivos
    </button>
</form>

<p class="result" style="visibility: hidden;"></p>

<style>
    input:not(:placeholder-shown):invalid,
    select:invalid:not(:focus) {
        border: 1px solid red !important;
    }

    .food-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
        position: relative;
    }

    .food-item h4 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1em;
        color: #333;
    }

    .remove-food-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none !important;
        border: none !important;
        color: #f44336 !important;
        cursor: pointer;
        font-size: 0.95em !important;
        text-decoration: underline !important;
        padding: 0 !important;
    }

    .remove-food-btn:hover,
    .remove-food-btn:focus,
    .remove-food-btn:active {
        background: none !important;
        color: #f44336 !important;
        text-decoration: underline !important;
    }
</style>

<script type="text/javascript">
    (function() {

        class FoodItem {
            name;
            carbs;
            fiber;
            erythritol;
            allulose;
            maltitol;
            xylitol;
            sorbitol;
            otherAlcohols;

            constructor(name, carbs, fiber, erythritol, allulose, maltitol, xylitol, sorbitol, otherAlcohols) {
                this.name = name;
                this.carbs = carbs;
                this.fiber = fiber;
                this.erythritol = erythritol;
                this.allulose = allulose;
                this.maltitol = maltitol;
                this.xylitol = xylitol;
                this.sorbitol = sorbitol;
                this.otherAlcohols = otherAlcohols;
            }
        }

        class DiabeticCarbsCalculator {
            _region;
            _profile;
            _foods;

            constructor(region, profile, foods) {
                this._region = region;
                this._profile = profile;
                this._foods = foods;
            }

            calculateFoodEffectiveCarbs(food) {
                // Step 1: CHO_decl based on region
                let carbsDecl = food.carbs;

                // Step 2: Fiber adjustment
                let fiberAdjustment = 0;
                if (this._region === 'US' && this._profile === 'ADA' && food.fiber >= 5) {
                    fiberAdjustment = food.fiber * 0.5;
                }

                let carbsPostFiber = Math.max(0, carbsDecl - fiberAdjustment);

                // Step 3: Sugar alcohols factors based on profile
                let factors = this._getAlcoholFactors();

                // Step 4: Calculate total alcohol discount
                let alcoholDiscount =
                    (factors.erythritol * food.erythritol) +
                    (factors.allulose * food.allulose) +
                    (factors.maltitol * food.maltitol) +
                    (factors.xylitol * food.xylitol) +
                    (factors.sorbitol * food.sorbitol) +
                    (factors.others * food.otherAlcohols);

                // Step 5: Calculate effective carbs
                let effective = Math.max(0, carbsPostFiber - alcoholDiscount);

                return {
                    effective: Math.round(effective * 10) / 10,
                    fiberAdjusted: fiberAdjustment,
                    alcoholsDiscounted: Math.round(alcoholDiscount * 10) / 10
                };
            }

            _getAlcoholFactors() {
                if (this._profile === 'ADA') {
                    return {
                        erythritol: 1.0,
                        allulose: 0.5,
                        maltitol: 0.5,
                        xylitol: 0.5,
                        sorbitol: 0.5,
                        others: 0.5
                    };
                } else { // Conservador
                    return {
                        erythritol: 1.0,
                        allulose: 0.25,
                        maltitol: 0.25,
                        xylitol: 0.25,
                        sorbitol: 0.25,
                        others: 0.25
                    };
                }
            }

            get totalEffectiveCarbs() {
                let total = 0;
                this._foods.forEach(food => {
                    const result = this.calculateFoodEffectiveCarbs(food);
                    total += result.effective;
                });
                return Math.round(total * 10) / 10;
            }

            getRations(rationSize, rounding) {
                const rations = this.totalEffectiveCarbs / rationSize;
                return this._roundRations(rations, rounding);
            }

            _roundRations(value, rounding) {
                const roundingValue = parseFloat(rounding);
                if (roundingValue === 1) {
                    return Math.round(value);
                } else {
                    return Math.round(value / roundingValue) * roundingValue;
                }
            }

            get classification() {
                const effective = this.totalEffectiveCarbs;
                if (effective < 20) {
                    return 'baja';
                } else if (effective <= 40) {
                    return 'moderada';
                } else {
                    return 'alta';
                }
            }

            getFoodsBreakdown() {
                return this._foods.map(food => {
                    const result = this.calculateFoodEffectiveCarbs(food);
                    return {
                        name: food.name || 'Sin nombre',
                        effective: result.effective,
                        fiberAdjusted: result.fiberAdjusted,
                        alcoholsDiscounted: result.alcoholsDiscounted
                    };
                });
            }
        }

        // Selects
        const REGION_SELECT = document.querySelector('#region');
        const PROFILE_SELECT = document.querySelector('#profile');
        const RATION_SIZE_SELECT = document.querySelector('#rationSize');
        const ROUNDING_SELECT = document.querySelector('#rounding');

        const FOODS_CONTAINER = document.querySelector('#foodsContainer');
        const ADD_FOOD_BTN = document.querySelector('#addFoodBtn');

        const FORM = document.querySelector('.form-container');
        const RESULT_BOX = document.querySelector('.result');
        const CALCULATE_BTN = document.querySelector('#calculate-btn');

        // Regex to validate decimal numbers
        const DECIMALS_REGEX = new RegExp(/^(\d+|\d+,\d{1,2}|\d+\.\d{1,2})$/);

        let foodCounter = 0;

        // Function to create a food item
        function createFoodItem() {
            foodCounter++;
            const foodId = `food${foodCounter}`;

            const foodDiv = document.createElement('div');
            foodDiv.className = 'food-item';
            foodDiv.dataset.foodId = foodId;

            foodDiv.innerHTML = `
                <h4>Alimento ${foodCounter}</h4>
                ${foodCounter > 1 ? '<button type="button" class="remove-food-btn">Eliminar</button>' : ''}

                <div class="flex">
                    <div>
                        <label><span>Nombre del alimento</span></label>
                        <input type="text" id="${foodId}_name" name="${foodId}_name_input" placeholder="Ej: Pan integral (opcional)">
                    </div>
                </div>

                <div class="flex">
                    <div>
                        <label><span>Carbohidratos totales</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_carbs" name="${foodId}_carbs_input" class="required-food-field" min="0" maxlength="6" placeholder="Ej: 25" required>
                        <span id="invalid_${foodId}_carbs" style="display: none;"></span>
                    </div>
                    <div>
                        <label><span>Fibra</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_fiber" name="${foodId}_fiber_input" min="0" maxlength="6" placeholder="Ej: 6">
                        <span id="invalid_${foodId}_fiber" style="display: none;"></span>
                    </div>
                </div>

                <h4 style="margin-top: 15px; font-size: 0.95em; font-weight: normal;">Polialcoholes (si aplica)</h4>

                <div class="flex">
                    <div>
                        <label><span>Eritritol</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_erythritol" name="${foodId}_erythritol_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                    <div>
                        <label><span>Alulosa</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_allulose" name="${foodId}_allulose_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                </div>

                <div class="flex">
                    <div>
                        <label><span>Maltitol</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_maltitol" name="${foodId}_maltitol_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                    <div>
                        <label><span>Xilitol</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_xylitol" name="${foodId}_xylitol_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                </div>

                <div class="flex">
                    <div>
                        <label><span>Sorbitol</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_sorbitol" name="${foodId}_sorbitol_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                    <div>
                        <label><span>Otros polialcoholes</span><sup>g</sup></label>
                        <input type="text" id="${foodId}_otherAlcohols" name="${foodId}_otherAlcohols_input" min="0" maxlength="6" placeholder="Ej: 0">
                    </div>
                </div>
            `;

            FOODS_CONTAINER.appendChild(foodDiv);

            // Add validation to numeric inputs
            const numericInputs = foodDiv.querySelectorAll('input[type="text"]:not([id$="_name"])');
            numericInputs.forEach(input => {
                input.addEventListener('input', () => validateNumericInput(input));
            });

            // Add remove button event listener
            if (foodCounter > 1) {
                const removeBtn = foodDiv.querySelector('.remove-food-btn');
                removeBtn.addEventListener('click', () => removeFoodItem(foodDiv));
            }
        }

        function removeFoodItem(foodDiv) {
            foodDiv.remove();
        }

        // Validate numeric input helper
        function validateNumericInput(input) {
            if (input.value === '' || input.value.trim() === '') {
                input.setCustomValidity('');
                return;
            }

            if (!DECIMALS_REGEX.test(input.value)) {
                input.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                input.reportValidity();
                return;
            }

            const value = parseFloat(input.value.replace(',', '.'));
            if (value < 0 || isNaN(value)) {
                input.setCustomValidity('El valor debe ser mayor o igual a 0');
                input.reportValidity();
            } else {
                input.setCustomValidity('');
            }
        }

        // Add food button
        ADD_FOOD_BTN.addEventListener('click', () => {
            createFoodItem();
        });

        // Validate selects
        const SELECTS = document.querySelectorAll('select');
        SELECTS.forEach(select => {
            select.addEventListener('change', () => {
                if (select.value !== "" && select.selectedIndex !== 0) {
                    select.setCustomValidity('');
                }
            });
        });

        // Initialize with one food item
        createFoodItem();

        FORM.addEventListener('submit', (e) => {
            e.preventDefault();

            // Validate all selects
            const selects = document.querySelectorAll('select');
            let isValid = true;

            selects.forEach(select => {
                if (select.value === "" || select.selectedIndex === 0) {
                    select.setCustomValidity('Por favor, selecciona una opción');
                    select.reportValidity();
                    isValid = false;
                } else {
                    select.setCustomValidity('');
                }
            });

            if (!isValid) {
                return;
            }

            // Validate that at least one food has carbs
            const foodItems = document.querySelectorAll('.food-item');
            const foods = [];

            for (let foodDiv of foodItems) {
                const foodId = foodDiv.dataset.foodId;

                const nameInput = document.querySelector(`#${foodId}_name`);
                const carbsInput = document.querySelector(`#${foodId}_carbs`);
                const fiberInput = document.querySelector(`#${foodId}_fiber`);
                const erythritolInput = document.querySelector(`#${foodId}_erythritol`);
                const alluloseInput = document.querySelector(`#${foodId}_allulose`);
                const maltitolInput = document.querySelector(`#${foodId}_maltitol`);
                const xylitolInput = document.querySelector(`#${foodId}_xylitol`);
                const sorbitolInput = document.querySelector(`#${foodId}_sorbitol`);
                const otherAlcoholsInput = document.querySelector(`#${foodId}_otherAlcohols`);

                // Validate carbs (required for each food)
                if (!carbsInput.value || carbsInput.value.trim() === '') {
                    carbsInput.setCustomValidity('Por favor, introduce los carbohidratos totales');
                    carbsInput.reportValidity();
                    return;
                }

                if (!DECIMALS_REGEX.test(carbsInput.value)) {
                    carbsInput.setCustomValidity('Introduce un número válido (máximo 2 decimales)');
                    carbsInput.reportValidity();
                    return;
                }

                const totalCarbs = parseFloat(carbsInput.value.replace(',', '.'));
                if (totalCarbs < 0 || isNaN(totalCarbs)) {
                    carbsInput.setCustomValidity('El valor debe ser mayor o igual a 0');
                    carbsInput.reportValidity();
                    return;
                }

                // Parse all values for this food
                const food = new FoodItem(
                    nameInput.value.trim(),
                    totalCarbs,
                    fiberInput.value && fiberInput.value.trim() !== '' ? parseFloat(fiberInput.value.replace(',', '.')) || 0 : 0,
                    erythritolInput.value && erythritolInput.value.trim() !== '' ? parseFloat(erythritolInput.value.replace(',', '.')) || 0 : 0,
                    alluloseInput.value && alluloseInput.value.trim() !== '' ? parseFloat(alluloseInput.value.replace(',', '.')) || 0 : 0,
                    maltitolInput.value && maltitolInput.value.trim() !== '' ? parseFloat(maltitolInput.value.replace(',', '.')) || 0 : 0,
                    xylitolInput.value && xylitolInput.value.trim() !== '' ? parseFloat(xylitolInput.value.replace(',', '.')) || 0 : 0,
                    sorbitolInput.value && sorbitolInput.value.trim() !== '' ? parseFloat(sorbitolInput.value.replace(',', '.')) || 0 : 0,
                    otherAlcoholsInput.value && otherAlcoholsInput.value.trim() !== '' ? parseFloat(otherAlcoholsInput.value.replace(',', '.')) || 0 : 0
                );

                foods.push(food);
            }

            // Parse configuration
            const region = REGION_SELECT.value;
            const profile = PROFILE_SELECT.value;
            const rationSize = parseFloat(RATION_SIZE_SELECT.value);
            const rounding = ROUNDING_SELECT.value;

            CALCULATE_BTN.innerHTML = 'Calculando...';
            RESULT_BOX.style.visibility = 'hidden';

            const calculator = new DiabeticCarbsCalculator(region, profile, foods);

            const totalEffectiveCarbs = calculator.totalEffectiveCarbs;
            const rations = calculator.getRations(rationSize, rounding);
            const classification = calculator.classification;
            const breakdown = calculator.getFoodsBreakdown();

            setTimeout(() => {
                RESULT_BOX.scrollIntoView({ behavior: 'smooth', block: 'center' });
                CALCULATE_BTN.innerHTML = 'Calcular carbohidratos efectivos';
                RESULT_BOX.style.visibility = 'visible';

                let html = `<span>Carbohidratos efectivos de la comida: <strong>${totalEffectiveCarbs.toString().replace('.', ',')} g</strong></span><br><br>`;
                html += `<span>Equivalen a <strong>${rations.toString().replace('.', ',')} raciones de ${rationSize} g</strong></span><br>`;
                html += `<span>Clasificación: <strong>carga ${classification}</strong> (${totalEffectiveCarbs.toString().replace('.', ',')} g)</span><br><br>`;

                // Add breakdown if more than one food
                if (foods.length > 1) {
                    html += `<span style="font-weight: bold; font-size: 0.95em;">Desglose por alimento:</span><br>`;
                    breakdown.forEach((item, index) => {
                        html += `<span style="font-size: 0.9em;">• ${item.name}: ${item.effective.toString().replace('.', ',')} g efectivos</span><br>`;
                    });
                    html += `<br>`;
                }

                html += `<span style="font-size: 0.9em; color: #666;">Región: ${region === 'UE' ? 'UE' : 'EE. UU./otros'}. Perfil: ${profile}.</span><br><br>`;

                html += `<span style="font-weight: bold; font-size: 0.95em;">Notas</span><br>`;
                html += `<span style="font-size: 0.85em;">• Esta herramienta no es médica ni calcula dosis de insulina.</span><br>`;
                html += `<span style="font-size: 0.85em;">• En UE, los "hidratos de carbono" ya excluyen la fibra; no restarla para evitar dobles descuentos.</span><br>`;
                html += `<span style="font-size: 0.85em;">• El efecto real de los polialcoholes varía entre individuos y productos; los factores propuestos son orientativos.</span>`;

                RESULT_BOX.innerHTML = html;
            }, 500);
        });

    })();
</script>
